---
import { analyticsManager } from '../../utils/database';

// Fetch analytics data
const days = 30;
const summary = analyticsManager.getSummary(days);
const dailyStats = analyticsManager.getDailyStats(days);
const topPages = analyticsManager.getTopPages(20, days);
const topReferers = analyticsManager.getTopReferers(20, days);
const avgTimeOnPage = analyticsManager.getAverageTimeOnPage(days);
const recentEvents = analyticsManager.getRecentEvents(50);

// Prepare chart data (reverse for chronological order)
const chartLabels = dailyStats.map((d) => d.date).reverse();
const chartVisits = dailyStats.map((d) => d.visits).reverse();
const chartUnique = dailyStats.map((d) => d.uniqueVisitors).reverse();

// Format duration helper
function formatDuration(seconds: number): string {
    if (seconds < 60) return `${Math.round(seconds)}s`;
    const mins = Math.floor(seconds / 60);
    const secs = Math.round(seconds % 60);
    return `${mins}m ${secs}s`;
}

// Format timestamp helper
function formatTimestamp(unixSeconds: number): string {
    return new Date(unixSeconds * 1000).toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
    });
}
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex, nofollow" />
        <title>Analytics Dashboard | Alessandro Romano</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    </head>
    <body>
        <div class="dashboard">
            <header>
                <h1>üìä Analytics Dashboard</h1>
                <span class="period-badge">Last {days} days</span>
            </header>

            <section class="stats-grid">
                <div class="stat-card">
                    <h3>Total Page Views</h3>
                    <div class="value">{summary.totalVisits.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>Unique Visitors</h3>
                    <div class="value">{summary.uniqueVisitors.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Events</h3>
                    <div class="value">{summary.totalEvents.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>Avg. Time on Page</h3>
                    <div class="value">{formatDuration(summary.avgTimeOnPage)}</div>
                </div>
            </section>

            <section class="chart-container">
                <h2>Daily Traffic</h2>
                <div class="chart-wrapper">
                    <canvas id="trafficChart"></canvas>
                </div>
            </section>

            <section class="tables-grid">
                <div class="table-card">
                    <h2>Top Pages</h2>
                    {
                        topPages.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Path</th>
                                        <th class="number-cell">Views</th>
                                        <th class="number-cell">Unique</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {topPages.map((page) => (
                                        <tr>
                                            <td class="path-cell" title={page.path}>
                                                {page.path}
                                            </td>
                                            <td class="number-cell">{page.visits.toLocaleString()}</td>
                                            <td class="number-cell">{page.uniqueVisitors.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div class="empty-state">No data yet</div>
                        )
                    }
                </div>

                <div class="table-card">
                    <h2>Top Referers</h2>
                    {
                        topReferers.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Source</th>
                                        <th class="number-cell">Visits</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {topReferers.map((ref) => (
                                        <tr>
                                            <td class="path-cell" title={ref.referer}>
                                                {ref.referer}
                                            </td>
                                            <td class="number-cell">{ref.visits.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div class="empty-state">No data yet</div>
                        )
                    }
                </div>

                <div class="table-card">
                    <h2>Avg. Time on Page (by path)</h2>
                    {
                        avgTimeOnPage.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Path</th>
                                        <th class="number-cell">Avg. Time</th>
                                        <th class="number-cell">Samples</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {avgTimeOnPage.map((item) => (
                                        <tr>
                                            <td class="path-cell" title={item.path}>
                                                {item.path}
                                            </td>
                                            <td class="number-cell">{formatDuration(item.avgDuration)}</td>
                                            <td class="number-cell">{item.samples}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div class="empty-state">Not enough data yet (min 3 samples per page)</div>
                        )
                    }
                </div>

                <div class="table-card full-width">
                    <h2>Recent Events</h2>
                    {
                        recentEvents.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Type</th>
                                        <th>Path</th>
                                        <th>Element</th>
                                        <th class="number-cell">Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {recentEvents.map((event) => (
                                        <tr>
                                            <td style="white-space: nowrap;">{formatTimestamp(event.createdAt)}</td>
                                            <td>
                                                <span class={`event-type event-type-${event.type}`}>
                                                    {event.type === 'click' ? 'üñ±Ô∏è' : '‚è±Ô∏è'} {event.type}
                                                </span>
                                            </td>
                                            <td class="path-cell" title={event.path}>
                                                {event.path}
                                            </td>
                                            <td class="path-cell" title={event.href || event.elementText || ''}>
                                                {event.type === 'click' ? (
                                                    <>
                                                        {event.elementTag && <code>&lt;{event.elementTag}&gt;</code>}
                                                        {event.elementId && (
                                                            <span class="element-id">#{event.elementId}</span>
                                                        )}
                                                        {event.elementText && (
                                                            <span class="element-text">{event.elementText}</span>
                                                        )}
                                                        {event.href && <span class="element-href">‚Üí {event.href}</span>}
                                                    </>
                                                ) : (
                                                    '‚Äî'
                                                )}
                                            </td>
                                            <td class="number-cell">
                                                {event.duration ? formatDuration(event.duration / 1000) : '‚Äî'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div class="empty-state">No events recorded yet</div>
                        )
                    }
                </div>
            </section>
        </div>

        <script is:inline define:vars={{ chartLabels, chartVisits, chartUnique }}>
            // Set up chart data in global scope
            window.__chartData = { chartLabels, chartVisits, chartUnique };
        </script>

        <script>
            import { Chart, registerables } from 'chart.js';

            // Type declarations for data passed from server
            declare global {
                interface Window {
                    __chartData: {
                        chartLabels: string[];
                        chartVisits: number[];
                        chartUnique: number[];
                    };
                }
            }

            // Register Chart.js components
            Chart.register(...registerables);

            // Get chart data from global scope
            const { chartLabels, chartVisits, chartUnique } = window.__chartData;

            // Create the chart
            const canvas = document.getElementById('trafficChart') as HTMLCanvasElement;
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                {
                                    label: 'Page Views',
                                    data: chartVisits,
                                    borderColor: '#e94560',
                                    backgroundColor: 'rgba(233, 69, 96, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                },
                                {
                                    label: 'Unique Visitors',
                                    data: chartUnique,
                                    borderColor: '#4ade80',
                                    backgroundColor: 'rgba(74, 222, 128, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            scales: {
                                x: {
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#a0a0a0' },
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#a0a0a0' },
                                },
                            },
                            plugins: {
                                legend: {
                                    labels: { color: '#eaeaea' },
                                },
                            },
                        },
                    });
                }
            }
        </script>
    </body>
</html>

<style>
    @import '../../styles/theme.css';

    /* Dashboard-specific color overrides for dark admin theme */
    :root {
        --admin-bg: oklch(0.15 0.03 260);
        --admin-card: oklch(0.18 0.04 260);
        --admin-border: oklch(0.25 0.05 260);
        --admin-accent: oklch(0.65 0.25 15);
        --admin-success: oklch(0.75 0.2 145);
        --admin-info: oklch(0.7 0.15 250);
        --admin-warning: oklch(0.75 0.18 85);
    }

    body {
        font-family: var(--font-family);
        background: var(--admin-bg);
        color: var(--color-text);
        line-height: var(--line-height-base);
        padding: var(--space-lg);
    }

    .dashboard {
        max-width: 1400px;
        margin: 0 auto;
    }

    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-sm);
        border-bottom: 1px solid var(--admin-border);
    }

    header h1 {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-bold);
    }

    .period-badge {
        background: var(--admin-border);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--border-radius);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .stat-card {
        background: var(--admin-card);
        border: 1px solid var(--admin-border);
        border-radius: var(--border-radius-lg);
        padding: var(--space-md);
    }

    .stat-card h3 {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        font-weight: 500;
        margin-bottom: var(--space-xs);
    }

    .stat-card .value {
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--admin-accent);
    }

    .chart-container {
        background: var(--admin-card);
        border: 1px solid var(--admin-border);
        border-radius: var(--border-radius-lg);
        padding: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .chart-container h2 {
        font-size: var(--font-size-md);
        margin-bottom: var(--space-sm);
    }

    .chart-wrapper {
        height: 300px;
        position: relative;
    }

    .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--space-md);
    }

    .table-card {
        background: var(--admin-card);
        border: 1px solid var(--admin-border);
        border-radius: var(--border-radius-lg);
        padding: var(--space-md);
        overflow: hidden;
    }

    .table-card h2 {
        font-size: var(--font-size-md);
        margin-bottom: var(--space-sm);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        text-align: left;
        padding: 0.75rem;
        border-bottom: 1px solid var(--admin-border);
    }

    th {
        color: var(--color-text-secondary);
        font-weight: 500;
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    td {
        font-size: var(--font-size-sm);
    }

    tr:last-child td {
        border-bottom: none;
    }

    .path-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .number-cell {
        text-align: right;
        font-variant-numeric: tabular-nums;
    }

    .table-card.full-width {
        grid-column: 1 / -1;
    }

    .event-type {
        display: inline-block;
        padding: var(--space-xs) var(--space-xs);
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
        font-weight: 500;
    }

    .event-type-click {
        background: oklch(from var(--admin-info) l c h / 0.2);
        color: var(--admin-info);
    }

    .event-type-time_on_page {
        background: oklch(from var(--admin-success) l c h / 0.2);
        color: var(--admin-success);
    }

    .element-id {
        color: var(--admin-warning);
        font-size: var(--font-size-xs);
        margin-left: var(--space-xs);
    }

    .element-text {
        color: var(--color-text-secondary);
        font-size: var(--font-size-xs);
        margin-left: var(--space-xs);
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: middle;
    }

    .element-href {
        color: var(--admin-info);
        font-size: var(--font-size-xs);
        margin-left: var(--space-xs);
    }

    code {
        background: oklch(1 0 0 / 0.1);
        padding: 0.125rem var(--space-xs);
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-lg);
        color: var(--color-text-secondary);
    }

    @media (max-width: 768px) {
        body {
            padding: var(--space-sm);
        }

        header {
            flex-direction: column;
            gap: var(--space-sm);
            align-items: flex-start;
        }

        .tables-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
