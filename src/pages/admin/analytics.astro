---
import { analyticsManager } from '../../utils/database';

// Fetch analytics data
const days = 30;
const summary = analyticsManager.getSummary(days);
const dailyStats = analyticsManager.getDailyStats(days);
const topPages = analyticsManager.getTopPages(20, days);
const topReferers = analyticsManager.getTopReferers(20, days);
const avgTimeOnPage = analyticsManager.getAverageTimeOnPage(days);
const recentEvents = analyticsManager.getRecentEvents(50);

// Prepare chart data (reverse for chronological order)
const chartLabels = dailyStats.map((d) => d.date).reverse();
const chartVisits = dailyStats.map((d) => d.visits).reverse();
const chartUnique = dailyStats.map((d) => d.uniqueVisitors).reverse();

// Format duration helper
function formatDuration(seconds: number): string {
    if (seconds < 60) return `${Math.round(seconds)}s`;
    const mins = Math.floor(seconds / 60);
    const secs = Math.round(seconds % 60);
    return `${mins}m ${secs}s`;
}

// Format timestamp helper
function formatTimestamp(unixSeconds: number): string {
    return new Date(unixSeconds * 1000).toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
    });
}
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex, nofollow" />
        <title>Analytics Dashboard | Alessandro Romano</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <style>
            :root {
                --color-bg: #1a1a2e;
                --color-card: #16213e;
                --color-border: #0f3460;
                --color-text: #eaeaea;
                --color-text-muted: #a0a0a0;
                --color-accent: #e94560;
                --color-success: #4ade80;
                --font-family: system-ui, sans-serif;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: var(--font-family);
                background: var(--color-bg);
                color: var(--color-text);
                line-height: 1.6;
                padding: 2rem;
            }

            .dashboard {
                max-width: 1400px;
                margin: 0 auto;
            }

            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid var(--color-border);
            }

            header h1 {
                font-size: 1.75rem;
                font-weight: 600;
            }

            .period-badge {
                background: var(--color-border);
                padding: 0.5rem 1rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                color: var(--color-text-muted);
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                background: var(--color-card);
                border: 1px solid var(--color-border);
                border-radius: 0.75rem;
                padding: 1.5rem;
            }

            .stat-card h3 {
                font-size: 0.875rem;
                color: var(--color-text-muted);
                font-weight: 500;
                margin-bottom: 0.5rem;
            }

            .stat-card .value {
                font-size: 2rem;
                font-weight: 700;
                color: var(--color-accent);
            }

            .chart-container {
                background: var(--color-card);
                border: 1px solid var(--color-border);
                border-radius: 0.75rem;
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .chart-container h2 {
                font-size: 1.125rem;
                margin-bottom: 1rem;
            }

            .chart-wrapper {
                height: 300px;
                position: relative;
            }

            .tables-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 1.5rem;
            }

            .table-card {
                background: var(--color-card);
                border: 1px solid var(--color-border);
                border-radius: 0.75rem;
                padding: 1.5rem;
                overflow: hidden;
            }

            .table-card h2 {
                font-size: 1.125rem;
                margin-bottom: 1rem;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th,
            td {
                text-align: left;
                padding: 0.75rem;
                border-bottom: 1px solid var(--color-border);
            }

            th {
                color: var(--color-text-muted);
                font-weight: 500;
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            td {
                font-size: 0.875rem;
            }

            tr:last-child td {
                border-bottom: none;
            }

            .path-cell {
                max-width: 300px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .number-cell {
                text-align: right;
                font-variant-numeric: tabular-nums;
            }

            .table-card.full-width {
                grid-column: 1 / -1;
            }

            .event-type {
                display: inline-block;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.75rem;
                font-weight: 500;
            }

            .event-type-click {
                background: rgba(59, 130, 246, 0.2);
                color: #60a5fa;
            }

            .event-type-time_on_page {
                background: rgba(16, 185, 129, 0.2);
                color: #34d399;
            }

            .element-id {
                color: #f59e0b;
                font-size: 0.75rem;
                margin-left: 0.25rem;
            }

            .element-text {
                color: var(--color-text-muted);
                font-size: 0.75rem;
                margin-left: 0.5rem;
                max-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                display: inline-block;
                vertical-align: middle;
            }

            .element-href {
                color: #60a5fa;
                font-size: 0.75rem;
                margin-left: 0.5rem;
            }

            code {
                background: rgba(255, 255, 255, 0.1);
                padding: 0.125rem 0.25rem;
                border-radius: 0.25rem;
                font-size: 0.75rem;
            }

            .empty-state {
                text-align: center;
                padding: 2rem;
                color: var(--color-text-muted);
            }

            @media (max-width: 768px) {
                body {
                    padding: 1rem;
                }

                header {
                    flex-direction: column;
                    gap: 1rem;
                    align-items: flex-start;
                }

                .tables-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="dashboard">
            <header>
                <h1>üìä Analytics Dashboard</h1>
                <span class="period-badge">Last {days} days</span>
            </header>

            <section class="stats-grid">
                <div class="stat-card">
                    <h3>Total Page Views</h3>
                    <div class="value">{summary.totalVisits.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>Unique Visitors</h3>
                    <div class="value">{summary.uniqueVisitors.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Events</h3>
                    <div class="value">{summary.totalEvents.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>Avg. Time on Page</h3>
                    <div class="value">{formatDuration(summary.avgTimeOnPage)}</div>
                </div>
            </section>

            <section class="chart-container">
                <h2>Daily Traffic</h2>
                <div class="chart-wrapper">
                    <canvas id="trafficChart"></canvas>
                </div>
            </section>

            <section class="tables-grid">
                <div class="table-card">
                    <h2>Top Pages</h2>
                    {
                        topPages.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Path</th>
                                        <th class="number-cell">Views</th>
                                        <th class="number-cell">Unique</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {topPages.map((page) => (
                                        <tr>
                                            <td class="path-cell" title={page.path}>
                                                {page.path}
                                            </td>
                                            <td class="number-cell">{page.visits.toLocaleString()}</td>
                                            <td class="number-cell">{page.uniqueVisitors.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div class="empty-state">No data yet</div>
                        )
                    }
                </div>

                <div class="table-card">
                    <h2>Top Referers</h2>
                    {
                        topReferers.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Source</th>
                                        <th class="number-cell">Visits</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {topReferers.map((ref) => (
                                        <tr>
                                            <td class="path-cell" title={ref.referer}>
                                                {ref.referer}
                                            </td>
                                            <td class="number-cell">{ref.visits.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div class="empty-state">No data yet</div>
                        )
                    }
                </div>

                <div class="table-card">
                    <h2>Avg. Time on Page (by path)</h2>
                    {
                        avgTimeOnPage.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Path</th>
                                        <th class="number-cell">Avg. Time</th>
                                        <th class="number-cell">Samples</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {avgTimeOnPage.map((item) => (
                                        <tr>
                                            <td class="path-cell" title={item.path}>
                                                {item.path}
                                            </td>
                                            <td class="number-cell">{formatDuration(item.avgDuration)}</td>
                                            <td class="number-cell">{item.samples}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div class="empty-state">Not enough data yet (min 3 samples per page)</div>
                        )
                    }
                </div>

                <div class="table-card full-width">
                    <h2>Recent Events</h2>
                    {
                        recentEvents.length > 0 ? (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Type</th>
                                        <th>Path</th>
                                        <th>Element</th>
                                        <th class="number-cell">Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {recentEvents.map((event) => (
                                        <tr>
                                            <td style="white-space: nowrap;">{formatTimestamp(event.createdAt)}</td>
                                            <td>
                                                <span class={`event-type event-type-${event.type}`}>
                                                    {event.type === 'click' ? 'üñ±Ô∏è' : '‚è±Ô∏è'} {event.type}
                                                </span>
                                            </td>
                                            <td class="path-cell" title={event.path}>
                                                {event.path}
                                            </td>
                                            <td class="path-cell" title={event.href || event.elementText || ''}>
                                                {event.type === 'click' ? (
                                                    <>
                                                        {event.elementTag && <code>&lt;{event.elementTag}&gt;</code>}
                                                        {event.elementId && (
                                                            <span class="element-id">#{event.elementId}</span>
                                                        )}
                                                        {event.elementText && (
                                                            <span class="element-text">{event.elementText}</span>
                                                        )}
                                                        {event.href && <span class="element-href">‚Üí {event.href}</span>}
                                                    </>
                                                ) : (
                                                    '‚Äî'
                                                )}
                                            </td>
                                            <td class="number-cell">
                                                {event.duration ? formatDuration(event.duration / 1000) : '‚Äî'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div class="empty-state">No events recorded yet</div>
                        )
                    }
                </div>
            </section>
        </div>

        <script is:inline define:vars={{ chartLabels, chartVisits, chartUnique }}>
            // Set up chart data in global scope
            window.__chartData = { chartLabels, chartVisits, chartUnique };
        </script>

        <script>
            import { Chart, registerables } from 'chart.js';

            // Type declarations for data passed from server
            declare global {
                interface Window {
                    __chartData: {
                        chartLabels: string[];
                        chartVisits: number[];
                        chartUnique: number[];
                    };
                }
            }

            // Register Chart.js components
            Chart.register(...registerables);

            // Get chart data from global scope
            const { chartLabels, chartVisits, chartUnique } = window.__chartData;

            // Create the chart
            const canvas = document.getElementById('trafficChart') as HTMLCanvasElement;
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                {
                                    label: 'Page Views',
                                    data: chartVisits,
                                    borderColor: '#e94560',
                                    backgroundColor: 'rgba(233, 69, 96, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                },
                                {
                                    label: 'Unique Visitors',
                                    data: chartUnique,
                                    borderColor: '#4ade80',
                                    backgroundColor: 'rgba(74, 222, 128, 0.1)',
                                    fill: true,
                                    tension: 0.3,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            scales: {
                                x: {
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#a0a0a0' },
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#a0a0a0' },
                                },
                            },
                            plugins: {
                                legend: {
                                    labels: { color: '#eaeaea' },
                                },
                            },
                        },
                    });
                }
            }
        </script>
    </body>
</html>
