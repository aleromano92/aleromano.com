---
import { getCollection } from 'astro:content';
import BlogPostLayout from '../../layouts/BlogPostLayout.astro';
import { getLanguageFromURL } from '../../utils/i18n';
import { findPostBySlug, parsePostSlug, getLocalizedPostUrl } from '../../utils/posts';

const { slug } = Astro.params;
const currentLang = getLanguageFromURL(Astro.url.pathname);
const posts = await getCollection('blog');

// Find post in the current language
const post = findPostBySlug(posts, slug, currentLang);

if (!post) {
  // Try to find post in default language (en)
  const defaultPost = findPostBySlug(posts, slug, 'en');

  if (defaultPost) {
    // If found in default language, redirect to that URL
    return Astro.redirect(getLocalizedPostUrl(defaultPost));
  }

  return Astro.redirect('/404');
}

const { Content } = await post.render();
---

<BlogPostLayout frontmatter={post.data}>
  <Content />
</BlogPostLayout>
