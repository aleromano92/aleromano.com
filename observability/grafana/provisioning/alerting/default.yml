apiVersion: 1

contactPoints:
  - orgId: 1
    name: telegram-disk-alerts
    receivers:
      - uid: telegram-disk-alerts
        type: telegram
        settings:
          bottoken: "${TELEGRAM_BOT_TOKEN}"
          chatid: |
            ${TELEGRAM_CHAT_ID}
          parse_mode: HTML

policies:
  - orgId: 1
    receiver: telegram-disk-alerts
    group_by:
      - alertname
    group_wait: 0s
    group_interval: 30s
    repeat_interval: 999h

muteTimes: []
templates: []
groups:
  - orgId: 1
    name: vps-disk-usage-alerts
    folder: Infrastructure
    interval: 1m
    rules:
      - uid: vps-disk-warning-75
        title: VPS Disk Usage Warning > 75%
        condition: C
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 300
              to: 0
            model:
              editorMode: code
              expr: 100 * (1 - (node_filesystem_avail_bytes{mountpoint="/",fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{mountpoint="/",fstype!~"tmpfs|overlay"}))
              instant: false
              intervalMs: 1000
              maxDataPoints: 43200
              legendFormat: "{{instance}}"
              refId: A
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              expression: A
              reducer: last
              type: reduce
              refId: B
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              expression: $B > 75 && $B <= 85
              type: math
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 2m
        labels:
          severity: warning
          team: infra
        annotations:
          summary: VPS disk usage warning (>75%)
          description: Disk usage on / is above 75% and at or below 85%.

      - uid: vps-disk-warning-85
        title: VPS Disk Usage Warning > 85%
        condition: C
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 300
              to: 0
            model:
              editorMode: code
              expr: 100 * (1 - (node_filesystem_avail_bytes{mountpoint="/",fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{mountpoint="/",fstype!~"tmpfs|overlay"}))
              instant: false
              intervalMs: 1000
              maxDataPoints: 43200
              legendFormat: "{{instance}}"
              refId: A
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              expression: A
              reducer: last
              type: reduce
              refId: B
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              expression: $B > 85 && $B <= 93
              type: math
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 2m
        labels:
          severity: warning
          team: infra
        annotations:
          summary: VPS disk usage high warning (>85%)
          description: Disk usage on / is above 85% and at or below 93%.

      - uid: vps-disk-error-93
        title: VPS Disk Usage Error > 93%
        condition: C
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 300
              to: 0
            model:
              editorMode: code
              expr: 100 * (1 - (node_filesystem_avail_bytes{mountpoint="/",fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{mountpoint="/",fstype!~"tmpfs|overlay"}))
              instant: false
              intervalMs: 1000
              maxDataPoints: 43200
              legendFormat: "{{instance}}"
              refId: A
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              expression: A
              reducer: last
              type: reduce
              refId: B
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              expression: $B > 93
              type: math
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 2m
        labels:
          severity: error
          team: infra
        annotations:
          summary: VPS disk usage critical (>93%)
          description: Disk usage on / is above 93%.

  - orgId: 1
    name: nginx-log-alerts
    folder: Infrastructure
    interval: 1m
    rules:
      - uid: nginx-5xx-sustained
        title: Nginx 5xx sustained (logs)
        condition: C
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: sum(count_over_time({job="nginx"} |~ "HTTP/[0-9.]+\\\" 5[0-9]{2} " [5m]))
              queryType: range
              refId: A
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              expression: A
              reducer: last
              type: reduce
              refId: B
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              expression: $B > 10
              type: math
              refId: C
        noDataState: OK
        execErrState: Error
        for: 5m
        labels:
          severity: warning
          team: infra
          source: logs
        annotations:
          summary: Nginx is returning sustained 5xx responses
          description: Nginx produced more than 10 HTTP 5xx log lines over 5 minutes.
